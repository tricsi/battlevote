<template>

  <div v-if="loading">
    <div class="d-flex justify-content-center">
      <b-spinner label="Loading entries..."></b-spinner>
    </div>
  </div>

  <div v-else>
    <b-form inline class="d-flex">
      <b-form-input v-model="search" placeholder="Search" class="flex-grow-1 mr-md-2 mb-3" />
      <b-form-select v-model="category" :options="categories" class="mb-3">
        <option slot="first" :value="null">All Category</option>
      </b-form-select>
    </b-form>
    <b-table :items="items" :fields="fields" :filter-function="filterTable" filter="true" striped responsive>
      <template v-slot:cell(title)="data">
        <router-link :to="{name: 'entry', params:{id: data.item.id}}">{{ data.item.title }}</router-link>
      </template>
    </b-table>
  </div>

</template>

<script>
import Axios from "axios";
import {
  BForm,
  BFormInput,
  BFormSelect
} from "bootstrap-vue";
import Config from "../../config";

export default {

  components: {
    BForm,
    BFormInput,
    BFormSelect
  },

  data() {
    return {
      loading: true,
      items: null,
      length: 9999,
      search: "",
      category: null,
      categories: Config.categories,
      fields: [
        {
          key: "rank",
          label: "#",
          tdClass: "text-right",
          thClass: "text-right",
          thStyle: "width: 1%",
          formatter: value => value || ''
        },
        {
          key: "title",
          label: "Game"
        },
        {
          key: "votes.length",
          label: "Votes",
          tdClass: "text-center",
          thStyle: "width: 1%"
        },
        {
          key: "score",
          label: "Score",
          tdClass: "text-center",
          thStyle: "width: 1%"
        },
        {
          key: "tbs",
          label: "TBS",
          headerTitle: "Tie Break Score",
          tdClass: "text-center",
          thStyle: "width: 1%"
        }
      ]
    };
  },

  async created() {
    try {
      const response = await Axios.get("/api/entry");
      const data = response.data;
      this.sortByScore(data);
      this.computeRank(data);
      this.items = data;
      this.loading = false;
    } catch (error) {
      this.$router.replace("/");
    }
  },

  methods: {

    filterTable(item) {
      let result = true;
      if (this.search) {
        result = item.title.toLowerCase().includes(this.search.toLowerCase());
      }
      if (result && this.category) {
        result = item.category.includes(this.category);
      }
      return result;
    },

    sortByScore(data) {
      data.sort((a, b) => {
        let result = b.score - a.score;
        if (result === 0) {
          result = b.tbs - a.tbs;
        }
        return result;
      });
    },

    computeRank(data) {
      let rank = 1;
      data[0].rank = data[0].round ? rank : 0;
      for (let i = 1; i < data.length; i++) {
        const item1 = data[i - 1];
        const item2 = data[i];
        if (item1.score > item2.score || item1.tbs > item2.tbs) {
          rank = i + 1;
        }
        item2.rank = item2.round ? rank : 0;
      }
    }
  }
};
</script>
